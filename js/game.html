<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <title>Math Game</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 40px 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, Arial, sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .game {
      width: min(90vw, 540px);
      background: #fff;
      border-radius: 14px;
      padding: 24px 22px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    h1 {
      margin: 0 0 4px;
      text-align: center;
      font-size: 40px;
    }

    .meta {
      text-align: center;
      font-size: 20px;
      color: #666;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      margin: 14px 0 20px;
      font-size: 18px;
    }

    .question {
      text-align: center;
      font-size: 38px;
      margin: 20px 0 8px;
      min-height: 30px;
    }

    .hint {
      text-align: center;
      font-size: 18px;
      color: #777;
      margin-bottom: 14px;
      min-height: 16px;
    }

    form {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 11px;
      font-size: 20px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
    }

    button {
      padding: 9px 13px;
      border-radius: 6px;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    #submitBtn {
      background: #16a34a;
      color: #fff;
      white-space: nowrap;
    }

    #submitBtn:disabled {
      background: #9ca3af;
      cursor: default;
    }

    .feedback {
      text-align: center;
      min-height: 25px;
      font-size: 20px;
      margin-top: 4px;
    }

    .bottom-buttons {
      text-align: center;
      margin-top: 10px;
    }

    #restartBtn,
    #exitBtn {
      display: none;
      margin: 0 4px;
      padding: 6px 12px;
      font-size: 18px;
    }

    #restartBtn {
      background: #2563eb;
      color: #fff;
    }

    #exitBtn {
      background: #ef4444;
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="game">
    <h1>Math Game</h1>
    <div class="meta" id="levelName"></div>
    <div class="meta" id="questionCounter"></div>

    <div class="stats">
      <div>Правильных: <span id="correctCount">0</span></div>
      <div>Неправильных: <span id="wrongCount">0</span></div>
    </div>

    <div class="question" id="questionText"></div>
    <div class="hint" id="answerHint"></div>

    <form id="answerForm">
      <input type="text" id="answerInput" placeholder="Введите ответ" autocomplete="off">
      <button type="submit" id="submitBtn">Ответить</button>
    </form>

    <div class="feedback" id="feedback"></div>

    <div class="bottom-buttons">
      <button id="restartBtn">Сыграть заново</button>
      <button id="exitBtn">Выйти</button>
    </div>
  </div>

  <script>
    const LEVELS = [
      { id: "primary", name: "Начальный", createQuestion: createPrimaryQuestion },
      { id: "middle", name: "Средний", createQuestion: createMiddleQuestion },
      { id: "advanced", name: "Продвинутый", createQuestion: createAdvancedQuestion }
    ];

    const levelNameEl = document.getElementById("levelName");
    const questionCounterEl = document.getElementById("questionCounter");
    const correctCountEl = document.getElementById("correctCount");
    const wrongCountEl = document.getElementById("wrongCount");
    const questionTextEl = document.getElementById("questionText");
    const answerHintEl = document.getElementById("answerHint");
    const feedbackEl = document.getElementById("feedback");
    const answerInputEl = document.getElementById("answerInput");
    const submitBtnEl = document.getElementById("submitBtn");
    const answerFormEl = document.getElementById("answerForm");
    const restartBtnEl = document.getElementById("restartBtn");
    const exitBtnEl = document.getElementById("exitBtn");

    const usedQuestions = new Set();

    let levelIndex = 0;
    let questionsInLevel = 0;
    let levelCorrect = 0;
    let totalCorrect = 0;
    let totalWrong = 0;
    let currentQuestion = null;
    let gameRunning = false;

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function padBinary(num, width = 4) {
      return num.toString(2).padStart(width, "0");
    }

    function startGame() {
      levelIndex = 0;
      totalCorrect = 0;
      totalWrong = 0;
      usedQuestions.clear();
      updateStats();
      startLevel();
    }

    function startLevel() {
      questionsInLevel = 0;
      levelCorrect = 0;
      gameRunning = true;
      feedbackEl.textContent = "";
      feedbackEl.style.color = "#111";
      answerInputEl.disabled = false;
      submitBtnEl.disabled = false;
      restartBtnEl.style.display = "none";
      exitBtnEl.style.display = "none";
      nextQuestion();
    }

    function nextQuestion() {
      if (!gameRunning) return;

      if (questionsInLevel >= 10) {
        endLevel();
        return;
      }

      const level = LEVELS[levelIndex];
      let q, key;
      do {
        q = level.createQuestion();
        key = `${level.id}|${q.text}`;
      } while (usedQuestions.has(key));
      usedQuestions.add(key);
      currentQuestion = q;

      questionsInLevel++;
      levelNameEl.textContent = `Уровень: ${level.name}`;
      questionCounterEl.textContent = `Вопрос ${questionsInLevel} из 10`;
      questionTextEl.textContent = q.text;

      if (q.type === "number") {
        answerHintEl.textContent = "Введите числовой ответ.";
      } else if (q.type === "bool") {
        answerHintEl.textContent = "Введите true/false, да/нет или 1/0.";
      } else {
        answerHintEl.textContent = "Ответ в двоичном виде (например 1010).";
      }

      answerInputEl.value = "";
      answerInputEl.focus();
    }

    function endLevel() {
      gameRunning = false;
      const percent = Math.round((levelCorrect / questionsInLevel) * 100);

      if (percent >= 80 && levelIndex < LEVELS.length - 1) {
        feedbackEl.style.color = "#16a34a";
        feedbackEl.textContent =
          `Уровень "${LEVELS[levelIndex].name}" пройден (${percent}%). Переходим дальше...`;
        levelIndex++;
        setTimeout(startLevel, 2000);
      } else if (percent >= 80 && levelIndex === LEVELS.length - 1) {
        feedbackEl.style.color = "#16a34a";
        feedbackEl.textContent =
          `Поздравляем! Вы прошли все уровни. Итог: ${totalCorrect} верных и ${totalWrong} неверных ответов.`;
        showEndButtons();
      } else {
        feedbackEl.style.color = "#ef4444";
        feedbackEl.textContent =
          `Уровень "${LEVELS[levelIndex].name}" не пройден (${percent}%). ` +
          `Верных ответов: ${levelCorrect} из ${questionsInLevel}.`;
        showEndButtons();
      }
    }

    function showEndButtons() {
      answerInputEl.disabled = true;
      submitBtnEl.disabled = true;
      restartBtnEl.style.display = "inline-block";
      exitBtnEl.style.display = "inline-block";
    }

    function updateStats() {
      correctCountEl.textContent = totalCorrect;
      wrongCountEl.textContent = totalWrong;
    }

    function createPrimaryQuestion() {
      const ops = ["+", "-", "*"];
      const a = randInt(1, 20);
      const b = randInt(1, 20);
      const op = ops[randInt(0, ops.length - 1)];
      let answer;
      switch (op) {
        case "+": answer = a + b; break;
        case "-": answer = a - b; break;
        case "*": answer = a * b; break;
      }
      return { text: `${a} ${op} ${b}`, answer, type: "number" };
    }

    function createMiddleQuestion() {
      const ops = [">", "<", ">=", "<=", "==", "!="];
      const a = randInt(0, 50);
      const b = randInt(0, 50);
      const op = ops[randInt(0, ops.length - 1)];
      const expr = `${a} ${op} ${b}`;
      let answer;
      switch (op) {
        case ">": answer = a > b; break;
        case "<": answer = a < b; break;
        case ">=": answer = a >= b; break;
        case "<=": answer = a <= b; break;
        case "==": answer = a == b; break;
        case "!=": answer = a != b; break;
      }
      return { text: expr, answer, type: "bool" };
    }

    function createAdvancedQuestion() {
      return randInt(0, 1) === 0 ? createLogicQuestion() : createBinaryQuestion();
    }

    function createLogicQuestion() {
      const A = Math.random() < 0.5;
      const B = Math.random() < 0.5;
      const pattern = randInt(1, 4);
      let text, answer;
      switch (pattern) {
        case 1: text = `${A} && ${B}`; answer = A && B; break;
        case 2: text = `${A} || ${B}`; answer = A || B; break;
        case 3: text = `!${A} && ${B}`; answer = !A && B; break;
        case 4: text = `${A} && !${B}`; answer = A && !B; break;
      }
      return { text, answer, type: "bool" };
    }

    function createBinaryQuestion() {
      const a = randInt(0, 15);
      const b = randInt(0, 15);
      const text = `${padBinary(a)} + ${padBinary(b)} (в двоичном виде)`;
      const answer = (a + b).toString(2);
      return { text, answer, type: "binary" };
    }

    function checkAnswer(question, raw) {
      const value = raw.trim();
      if (!value) return false;

      if (question.type === "number") {
        const num = Number(value);
        return !Number.isNaN(num) && num === question.answer;
      }

      if (question.type === "bool") {
        const v = value.toLowerCase();
        let userBool;
        if (["true", "истина", "да", "1"].includes(v)) userBool = true;
        else if (["false", "ложь", "нет", "0"].includes(v)) userBool = false;
        else return false;
        return userBool === question.answer;
      }

      if (question.type === "binary") {
        const cleaned = value.replace(/\s+/g, "");
        if (!/^[01]+$/.test(cleaned)) return false;
        return cleaned === question.answer;
      }

      return false;
    }

    answerFormEl.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!gameRunning || !currentQuestion) return;

      const userAnswer = answerInputEl.value;
      const isCorrect = checkAnswer(currentQuestion, userAnswer);

      if (isCorrect) {
        feedbackEl.style.color = "#16a34a";
        feedbackEl.textContent = "Верно!";
        totalCorrect++;
        levelCorrect++;
      } else {
        feedbackEl.style.color = "#ef4444";
        const show =
          currentQuestion.type === "binary"
            ? `${currentQuestion.answer} (двоичный результат)`
            : String(currentQuestion.answer);
        feedbackEl.textContent = `Неверно. Правильный ответ: ${show}`;
        totalWrong++;
      }

      updateStats();
      nextQuestion();
    });

    restartBtnEl.addEventListener("click", () => {
      startGame();
    });

    exitBtnEl.addEventListener("click", () => {
      gameRunning = false;
      answerInputEl.disabled = true;
      submitBtnEl.disabled = true;
      feedbackEl.style.color = "#111";
      feedbackEl.textContent = "Игра завершена. Спасибо за игру!";
    });

    startGame();
  </script>
</body>

</html>