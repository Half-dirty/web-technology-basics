<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Math Game</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .game-card {
      max-width: 420px;
      margin: 40px auto;
      padding: 24px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin: 0 0 10px;
    }
    .meta {
      text-align: center;
      margin-bottom: 8px;
      font-size: 14px;
      color: #555;
    }
    .stats {
      display: flex;
      justify-content: space-between;
      margin: 10px 0 20px;
      font-size: 14px;
    }
    .question {
      text-align: center;
      font-size: 28px;
      margin: 30px 0 10px;
      min-height: 36px;
    }
    .hint {
      text-align: center;
      font-size: 13px;
      color: #777;
      margin-bottom: 15px;
      min-height: 18px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    input[type="text"] {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
    #submitBtn {
      background-color: #2e7d32;
      color: #fff;
    }
    #submitBtn:disabled {
      background-color: #9e9e9e;
      cursor: default;
    }
    .bottom-buttons {
      margin-top: 15px;
      text-align: center;
    }
    #restartBtn, #exitBtn {
      display: none;
      margin: 0 5px;
      padding: 8px 14px;
      font-size: 14px;
    }
    #restartBtn {
      background-color: #1976d2;
      color: #fff;
    }
    #exitBtn {
      background-color: #e53935;
      color: #fff;
    }
    .feedback {
      text-align: center;
      margin-top: 15px;
      min-height: 22px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="game-card">
    <h1>Math Game</h1>
    <div class="meta" id="levelName"></div>
    <div class="meta" id="questionCounter"></div>

    <div class="stats">
      <div>Правильных: <span id="correctCount">0</span></div>
      <div>Неправильных: <span id="wrongCount">0</span></div>
    </div>

    <div class="question" id="questionText"></div>
    <div class="hint" id="answerHint"></div>

    <form id="answerForm">
      <input type="text" id="answerInput" placeholder="Введите ответ" autocomplete="off">
      <button type="submit" id="submitBtn">Ответить</button>
    </form>

    <div class="feedback" id="feedback"></div>

    <div class="bottom-buttons">
      <button id="restartBtn">Сыграть заново</button>
      <button id="exitBtn">Выход</button>
    </div>
  </div>

  <script>
    var levels = [
      { id: "primary",     name: "Начальный"   },
      { id: "middle",      name: "Средний"     },
      { id: "advanced",    name: "Продвинутый" }
    ];

    var currentLevelIndex = 0;
    var questionInLevel = 0;    
    var totalCorrect = 0;
    var totalWrong = 0;
    var levelCorrect = 0;       
    var currentQuestion = null;
    var usedQuestions = [];    
    var gameRunning = false;
    var gameFinished = false;

    var questionTextEl = document.getElementById("questionText");
    var levelNameEl = document.getElementById("levelName");
    var questionCounterEl = document.getElementById("questionCounter");
    var correctCountEl = document.getElementById("correctCount");
    var wrongCountEl = document.getElementById("wrongCount");
    var answerHintEl = document.getElementById("answerHint");
    var feedbackEl = document.getElementById("feedback");
    var answerInputEl = document.getElementById("answerInput");
    var submitBtnEl = document.getElementById("submitBtn");
    var restartBtnEl = document.getElementById("restartBtn");
    var exitBtnEl = document.getElementById("exitBtn");
    var answerFormEl = document.getElementById("answerForm");

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function hasQuestion(key) {
      for (var i = 0; i < usedQuestions.length; i++) {
        if (usedQuestions[i] === key) {
          return true;
        }
      }
      return false;
    }

    function updateStatsUI() {
      correctCountEl.textContent = totalCorrect;
      wrongCountEl.textContent = totalWrong;
    }

    function formatAnswer(q) {
      if (q.type === "number") {
        return String(q.answer);
      }
      if (q.type === "bool") {
        return q.answer ? "true (истина)" : "false (ложь)";
      }
      if (q.type === "binary") {
        return q.answer.toString(2) + " (в двоичной системе)";
      }
      return String(q.answer);
    }

    function generateQuestionForLevel(levelId) {
      if (levelId === "primary")  return generatePrimaryQuestion();
      if (levelId === "middle")   return generateMiddleQuestion();
      return generateAdvancedQuestion();
    }

    function generatePrimaryQuestion() {
      var ops = ["+", "-", "*"];
      var a = randInt(1, 20);
      var b = randInt(1, 20);
      var op = ops[randInt(0, ops.length - 1)];
      var answer;
      if (op === "+") {
        answer = a + b;
      } else if (op === "-") {
        answer = a - b;
      } else {
        answer = a * b;
      }
      return {
        text: a + " " + op + " " + b,
        answer: answer,
        type: "number"
      };
    }

    function generateMiddleQuestion() {
      var ops = [">", "<", ">=", "<=", "==", "!="];
      var a = randInt(0, 50);
      var b = randInt(0, 50);
      var op = ops[randInt(0, ops.length - 1)];
      var expr = a + " " + op + " " + b;
      var answer;
      if (op === ">")  answer = a > b;
      else if (op === "<")  answer = a < b;
      else if (op === ">=") answer = a >= b;
      else if (op === "<=") answer = a <= b;
      else if (op === "==") answer = (a == b);
      else answer = (a != b);
      return {
        text: expr,
        answer: answer,
        type: "bool"
      };
    }

    function generateAdvancedQuestion() {
      var choice = randInt(0, 1); 
      if (choice === 0) {
        return generateLogicQuestion();
      } else {
        return generateBinaryQuestion();
      }
    }

    function generateLogicQuestion() {
      var bools = [true, false];
      var A = bools[randInt(0, 1)];
      var B = bools[randInt(0, 1)];
      var pattern = randInt(1, 4);
      var text;
      var answer;
      if (pattern === 1) {
        text = A + " && " + B;
        answer = A && B;
      } else if (pattern === 2) {
        text = A + " || " + B;
        answer = A || B;
      } else if (pattern === 3) {
        text = "!" + A + " && " + B;
        answer = (!A) && B;
      } else {
        text = "!" + A + " || " + B;
        answer = (!A) || B;
      }
      return {
        text: text,
        answer: answer,
        type: "bool"
      };
    }

    function generateBinaryQuestion() {
      var a = randInt(0, 15);
      var b = randInt(0, 15);
      var binA = a.toString(2);
      var binB = b.toString(2);
      while (binA.length < 4) binA = "0" + binA;
      while (binB.length < 4) binB = "0" + binB;
      var text = binA + " + " + binB + " (в двоичной системе)";
      var answer = a + b;
      return {
        text: text,
        answer: answer,
        type: "binary"
      };
    }

    function startGame() {
      currentLevelIndex = 0;
      totalCorrect = 0;
      totalWrong = 0;
      usedQuestions = [];
      gameFinished = false;
      updateStatsUI();
      startLevel();
    }

    function startLevel() {
      levelCorrect = 0;
      questionInLevel = 0;
      gameRunning = true;

      feedbackEl.textContent = "";
      feedbackEl.style.color = "#000";
      answerInputEl.disabled = false;
      submitBtnEl.disabled = false;
      restartBtnEl.style.display = "none";
      exitBtnEl.style.display = "none";

      generateNextQuestion();
    }

    function generateNextQuestion() {
      if (!gameRunning) return;

      if (questionInLevel >= 10) {
        endLevel();
        return;
      }

      var levelId = levels[currentLevelIndex].id;
      var q;
      var key;
      do {
        q = generateQuestionForLevel(levelId);
        key = levelId + "|" + q.text;
      } while (hasQuestion(key));

      usedQuestions[usedQuestions.length] = key;
      currentQuestion = q;

      questionInLevel += 1;

      levelNameEl.textContent = "Уровень: " + levels[currentLevelIndex].name;
      questionCounterEl.textContent = "Вопрос " + questionInLevel + " из 10";
      questionTextEl.textContent = currentQuestion.text;

      var hint = "";
      if (currentQuestion.type === "number") {
        hint = "Введите числовой ответ.";
      } else if (currentQuestion.type === "bool") {
        hint = "Введите true/false, да/нет или 1/0.";
      } else if (currentQuestion.type === "binary") {
        hint = "Введите результат в двоичной системе (например 1010).";
      }
      answerHintEl.textContent = hint;
    }

    function endLevel() {
      gameRunning = false;
      var percent = Math.round((levelCorrect / questionInLevel) * 100);

      if (percent >= 80) {
        if (currentLevelIndex < levels.length - 1) {
          feedbackEl.style.color = "#2e7d32";
          feedbackEl.textContent =
            "Отлично! Вы прошли уровень \"" +
            levels[currentLevelIndex].name +
            "\" с результатом " + percent +
            "%. Переходим к следующему уровню...";

          currentLevelIndex += 1;

          setTimeout(function () {
            feedbackEl.textContent = "";
            startLevel();
          }, 2000);
        } else {
          feedbackEl.style.color = "#2e7d32";
          feedbackEl.textContent =
            "Поздравляем! Вы прошли все уровни. Итог: " +
            totalCorrect + " правильных и " +
            totalWrong + " неправильных ответов.";
          gameFinished = true;
          showEndButtons();
        }
      } else {
        feedbackEl.style.color = "#c62828";
        feedbackEl.textContent =
          "Уровень \"" + levels[currentLevelIndex].name +
          "\" не пройден. Правильных ответов: " +
          levelCorrect + " из " + questionInLevel +
          " (" + percent +
          "%). Вы можете начать игру заново или выйти.";
        gameFinished = true;
        showEndButtons();
      }
    }

    function showEndButtons() {
      restartBtnEl.style.display = "inline-block";
      exitBtnEl.style.display = "inline-block";
    }

    answerFormEl.addEventListener("submit", function (e) {
      e.preventDefault();
      if (!gameRunning || !currentQuestion) return;

      var raw = answerInputEl.value;
      var trimmed = raw.trim();
      if (trimmed === "") return;

      var isCorrect = false;

      if (currentQuestion.type === "number") {
        var userNum = Number(trimmed);
        if (!isNaN(userNum)) {
          isCorrect = (userNum === currentQuestion.answer);
        }
      } else if (currentQuestion.type === "bool") {
        var lower = trimmed.toLowerCase();
        var parsedBool = null;
        if (lower === "true" || lower === "истина" || lower === "да" || lower === "1") {
          parsedBool = true;
        } else if (lower === "false" || lower === "ложь" || lower === "нет" || lower === "0") {
          parsedBool = false;
        }
        if (parsedBool !== null) {
          isCorrect = (parsedBool === currentQuestion.answer);
        }
      } else if (currentQuestion.type === "binary") {
        var norm = trimmed.replace(/\s+/g, "");
        var valid = norm.length > 0;
        for (var i = 0; i < norm.length; i++) {
          var c = norm.charAt(i);
          if (c !== "0" && c !== "1") {
            valid = false;
            break;
          }
        }
        if (valid) {
          var userVal = parseInt(norm, 2);
          if (!isNaN(userVal)) {
            isCorrect = (userVal === currentQuestion.answer);
          }
        }
      }

      if (isCorrect) {
        feedbackEl.style.color = "#2e7d32";
        feedbackEl.textContent = "Верно!";
        totalCorrect += 1;
        levelCorrect += 1;
      } else {
        feedbackEl.style.color = "#c62828";
        feedbackEl.textContent =
          "Неверно. Правильный ответ: " + formatAnswer(currentQuestion);
        totalWrong += 1;
      }

      updateStatsUI();
      answerInputEl.value = "";

      if (questionInLevel >= 10) {
        endLevel();
      } else {
        generateNextQuestion();
      }
    });

    restartBtnEl.addEventListener("click", function () {
      answerInputEl.disabled = false;
      submitBtnEl.disabled = false;
      restartBtnEl.style.display = "none";
      exitBtnEl.style.display = "none";
      startGame();
    });

    exitBtnEl.addEventListener("click", function () {
      gameRunning = false;
      answerInputEl.disabled = true;
      submitBtnEl.disabled = true;
      questionTextEl.textContent = "Игра завершена.";
      answerHintEl.textContent = "";
    });
    startGame();
  </script>
</body>
</html>
